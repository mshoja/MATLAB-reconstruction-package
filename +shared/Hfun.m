function [H, H_coeff] = Hfun(J, remove2)

    if J <= 10
        H_coeff = {-1, [1; -1], [-1; 3], [1; -6; 3], [-1; 10; -15], [1; -15; 45; -15], [-1; 21; -105; 105], [1; -28; 210; -420; 105], [-1; 36; -378; 1260; -945], [1; -45; 630; -3150; 4725; -945]};
        H_coeff = H_coeff(1:J);
        if remove2
            switch J
                case 1
                    H = @(x)[];
                case 2
                    H = @(x)[];
                case 3
                    H = @(x)-x.*(x.^2-3.0);
                case 4
                    H = @(x)[-x.*(x.^2-3.0);x.^2 .*(x.^2-6.0)+3.0];
                case 5
                    H = @(x)[-x.*(x.^2-3.0);x.^2 .*(x.^2-6.0)+3.0;-x.*(x.^2 .*(x.^2-1.0e+1)+1.5e+1)];
                case 6
                    H = @(x)[-x.*(x.^2-3.0);x.^2 .*(x.^2-6.0)+3.0;-x.*(x.^2 .*(x.^2-1.0e+1)+1.5e+1);x.^2 .*(x.^2 .*(x.^2-1.5e+1)+4.5e+1)-1.5e+1];
                case 7
                    H = @(x)[-x.*(x.^2-3.0);x.^2 .*(x.^2-6.0)+3.0;-x.*(x.^2 .*(x.^2-1.0e+1)+1.5e+1);x.^2 .*(x.^2 .*(x.^2-1.5e+1)+4.5e+1)-1.5e+1;-x.*(x.^2 .*(x.^2 .*(x.^2-2.1e+1)+1.05e+2)-1.05e+2)];
                case 8
                    H = @(x)[-x.*(x.^2-3.0);x.^2 .*(x.^2-6.0)+3.0;-x.*(x.^2 .*(x.^2-1.0e+1)+1.5e+1);x.^2 .*(x.^2 .*(x.^2-1.5e+1)+4.5e+1)-1.5e+1;-x.*(x.^2 .*(x.^2 .*(x.^2-2.1e+1)+1.05e+2)-1.05e+2);x.^2 .*(x.^2 .*(x.^2 .*(x.^2-2.8e+1)+2.1e+2)-4.2e+2)+1.05e+2];
                case 9
                    H = @(x)[-x.*(x.^2-3.0);x.^2 .*(x.^2-6.0)+3.0;-x.*(x.^2 .*(x.^2-1.0e+1)+1.5e+1);x.^2 .*(x.^2 .*(x.^2-1.5e+1)+4.5e+1)-1.5e+1;-x.*(x.^2 .*(x.^2 .*(x.^2-2.1e+1)+1.05e+2)-1.05e+2);x.^2 .*(x.^2 .*(x.^2 .*(x.^2-2.8e+1)+2.1e+2)-4.2e+2)+1.05e+2;-x.*(x.^2 .*(x.^2 .*(x.^2 .*(x.^2-3.6e+1)+3.78e+2)-1.26e+3)+9.45e+2)];
                case 10
                    H = @(x)[-x.*(x.^2-3.0);x.^2 .*(x.^2-6.0)+3.0;-x.*(x.^2 .*(x.^2-1.0e+1)+1.5e+1);x.^2 .*(x.^2 .*(x.^2-1.5e+1)+4.5e+1)-1.5e+1;-x.*(x.^2 .*(x.^2 .*(x.^2-2.1e+1)+1.05e+2)-1.05e+2);x.^2 .*(x.^2 .*(x.^2 .*(x.^2-2.8e+1)+2.1e+2)-4.2e+2)+1.05e+2;-x.*(x.^2 .*(x.^2 .*(x.^2 .*(x.^2-3.6e+1)+3.78e+2)-1.26e+3)+9.45e+2);x.^2 .*(x.^2 .*(x.^2 .*(x.^2 .*(x.^2-4.5e+1)+6.3e+2)-3.15e+3)+4.725e+3)-9.45e+2];
            end
        else
            switch J
                case 1
                    H = @(x)-x;
                case 2
                    H = @(x)[-x;x.^2-1.0];
                case 3
                    H = @(x)[-x;x.^2-1.0;-x.*(x.^2-3.0)];
                case 4
                    H = @(x)[-x;x.^2-1.0;-x.*(x.^2-3.0);x.^2 .*(x.^2-6.0)+3.0];
                case 5
                    H = @(x)[-x;x.^2-1.0;-x.*(x.^2-3.0);x.^2 .*(x.^2-6.0)+3.0;-x.*(x.^2 .*(x.^2-1.0e+1)+1.5e+1)];
                case 6
                    H = @(x)[-x;x.^2-1.0;-x.*(x.^2-3.0);x.^2 .*(x.^2-6.0)+3.0;-x.*(x.^2 .*(x.^2-1.0e+1)+1.5e+1);x.^2 .*(x.^2 .*(x.^2-1.5e+1)+4.5e+1)-1.5e+1];
                case 7
                    H = @(x)[-x;x.^2-1.0;-x.*(x.^2-3.0);x.^2 .*(x.^2-6.0)+3.0;-x.*(x.^2 .*(x.^2-1.0e+1)+1.5e+1);x.^2 .*(x.^2 .*(x.^2-1.5e+1)+4.5e+1)-1.5e+1;-x.*(x.^2 .*(x.^2 .*(x.^2-2.1e+1)+1.05e+2)-1.05e+2)];
                case 8
                    H = @(x)[-x;x.^2-1.0;-x.*(x.^2-3.0);x.^2 .*(x.^2-6.0)+3.0;-x.*(x.^2 .*(x.^2-1.0e+1)+1.5e+1);x.^2 .*(x.^2 .*(x.^2-1.5e+1)+4.5e+1)-1.5e+1;-x.*(x.^2 .*(x.^2 .*(x.^2-2.1e+1)+1.05e+2)-1.05e+2);x.^2 .*(x.^2 .*(x.^2 .*(x.^2-2.8e+1)+2.1e+2)-4.2e+2)+1.05e+2];
                case 9
                    H = @(x)[-x;x.^2-1.0;-x.*(x.^2-3.0);x.^2 .*(x.^2-6.0)+3.0;-x.*(x.^2 .*(x.^2-1.0e+1)+1.5e+1);x.^2 .*(x.^2 .*(x.^2-1.5e+1)+4.5e+1)-1.5e+1;-x.*(x.^2 .*(x.^2 .*(x.^2-2.1e+1)+1.05e+2)-1.05e+2);x.^2 .*(x.^2 .*(x.^2 .*(x.^2-2.8e+1)+2.1e+2)-4.2e+2)+1.05e+2;-x.*(x.^2 .*(x.^2 .*(x.^2 .*(x.^2-3.6e+1)+3.78e+2)-1.26e+3)+9.45e+2)];
                case 10
                    H = @(x)[-x;x.^2-1.0;-x.*(x.^2-3.0);x.^2 .*(x.^2-6.0)+3.0;-x.*(x.^2 .*(x.^2-1.0e+1)+1.5e+1);x.^2 .*(x.^2 .*(x.^2-1.5e+1)+4.5e+1)-1.5e+1;-x.*(x.^2 .*(x.^2 .*(x.^2-2.1e+1)+1.05e+2)-1.05e+2);x.^2 .*(x.^2 .*(x.^2 .*(x.^2-2.8e+1)+2.1e+2)-4.2e+2)+1.05e+2;-x.*(x.^2 .*(x.^2 .*(x.^2 .*(x.^2-3.6e+1)+3.78e+2)-1.26e+3)+9.45e+2);x.^2 .*(x.^2 .*(x.^2 .*(x.^2 .*(x.^2-4.5e+1)+6.3e+2)-3.15e+3)+4.725e+3)-9.45e+2];
            end
        end
    else
        syms x dHdx
        H = sym('H', [J 1]);
        dHdx = exp(-x^2 / 2);
        for j = 1:J
            dHdx = diff(dHdx);
            H(j) = exp(x^2 / 2) * dHdx;
        end
        H = horner(H, x);
        H_coeff = cell(1, J);
        for j = 1:J
            H_coeff{j} = nonzeros(sym2poly(H(j)));
        end
        if remove2
            H = H(3:end);
        end
        H = matlabFunction(H);
    end
   
end


